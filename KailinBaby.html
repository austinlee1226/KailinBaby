<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¥½å¯¶å¯¶å…¨çå‹µè¨ˆç•« ğŸŒŸ</title>
    <style>
        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
        
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            background-color: #fef9e7;
            margin: 0; 
            padding: 10px;
            height: 100svh; /* ç¢ºä¿é©æ‡‰ LINE çš„é«˜åº¦ */
            display: flex; 
            flex-direction: column; 
            align-items: center;
            overflow: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .header {
            flex: 1;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            width: 100%;
        }

        .gift-box { 
            font-size: clamp(50px, 12vh, 80px); 
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1));
        }
        
        .shake { animation: shakeAnim 0.5s ease-in-out infinite; }
        @keyframes shakeAnim {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(15deg) scale(1.1); }
            75% { transform: rotate(-15deg) scale(1.1); }
        }

        #message {
            font-size: 18px; color: #2d3436; font-weight: bold;
            margin-top: 8px; text-align: center; height: 45px;
            padding: 0 10px; line-height: 1.3;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            width: 100%;
            max-width: 350px;
            background: white;
            padding: 12px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            flex: 3.2;
            align-content: center;
        }

        .slot {
            aspect-ratio: 1 / 1;
            border: 2px dashed #fab1a0;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px;
            background-color: #fff;
        }

        .slot.locked { opacity: 0.2; border-color: #dfe6e9; }
        .slot.completed {
            border-style: solid; 
            background-color: #fff9db; 
            border-color: #f1c40f;
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

        .controls { 
            flex: 0.8; 
            display: flex; 
            gap: 12px; 
            align-items: center; 
            width: 100%;
            justify-content: center;
            padding-bottom: 10px;
        }
        
        .btn { 
            padding: 10px 20px; 
            border-radius: 25px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 15px;
        }
        .btn-settings { background-color: #ff7675; color: white; }
        .btn-clear { background-color: #dfe6e9; color: #636e72; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 25px; width: 85%; max-height: 75vh;
            overflow-y: auto;
        }
        #reward-display {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff9f43, #ee5253); 
            color: white; padding: 35px 20px; border-radius: 30px;
            text-align: center; z-index: 3000; width: 85%;
        }
    </style>
</head>
<body>

    <div class="header">
        <div id="gift" class="gift-box">ğŸ</div>
        <div id="message">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="grid-container" id="grid"></div>

    <div class="controls">
        <button class="btn btn-settings" onclick="openSettings()">ğŸ“ è¨­å®šèˆ‡åç¨±</button>
        <button class="btn btn-clear" onclick="clearProgress()">ğŸ”„ é‡ç½®</button>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0; color:#ee5253;">âš™ï¸ è¨­å®šè¨ˆç•«</h2>
            <div style="margin-bottom: 15px;">
                <label style="font-weight:bold;">å¯¶è²çš„åå­—ï¼š</label>
                <input type="text" id="baby-name-input" style="width:100%;padding:10px;margin-top:5px;border-radius:8px;border:2px solid #ff7675;">
            </div>
            <div id="inputs-container"></div>
            <button class="btn btn-settings" style="width:100%; margin-top:15px;" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <div id="reward-display">
        <div id="reward-icon" style="font-size: 60px;">ğŸ‰</div>
        <h2 id="reward-title" style="margin:10px 0;">æ­å–œé”æˆï¼</h2>
        <p id="reward-text" style="font-size: 22px; font-weight: bold; margin: 15px 0; background: rgba(255,255,255,0.2); padding: 12px; border-radius: 15px;"></p>
        <button class="btn" id="claim-btn" style="background:white; color:#ee5253;" onclick="closeReward()">é ˜å–çå‹µ</button>
    </div>

    <script>
        const totalSlots = 30;
        const grid = document.getElementById('grid');
        const gift = document.getElementById('gift');
        const message = document.getElementById('message');
        const iconPool = ["ğŸ", "ğŸ“", "ğŸ‡", "ğŸ§¸", "ğŸš—", "âš½", "ğŸ¦", "ğŸˆ", "ğŸ­", "ğŸ©", "ğŸ›¸", "ğŸ¦’", "ğŸ¦–", "ğŸ¤–", "ğŸŒˆ"];
        
        const scripts = {
            cheers: ["{name}å¥½æ£’ï¼åœ–æ¡ˆæ”¶é›†+1 âœ¨", "{name}çœŸå„ªç§€ï¼ ğŸ’ª", "{name}åŠ æ²¹ï¼Œå¿«åˆ°äº†ï¼ ğŸƒâ€â™‚ï¸", "{name}è¡¨ç¾çµ¦ 100 åˆ†ï¼ ğŸ’¯"],
            almost: ["{name}å†ä¸€å€‹å°±é ˜çäº†ï¼ ğŸ¤©", "ç¦®ç‰©åœ¨è·³èˆäº†ï¼Œ{name}å¿«çœ‹ï¼ ğŸ"],
            welcome: ["{name}ä»Šå¤©è¦æ”¶é›†ä»€éº¼å‘¢ï¼Ÿ ğŸ˜Š", "{name}ï¼ŒæŒ‘æˆ°é–‹å§‹ï¼ â­"]
        };

        // --- æ ¸å¿ƒï¼šå¾æœ¬åœ°å„²å­˜è®€å–è³‡æ–™ ---
        let currentProgress = parseInt(localStorage.getItem('bearProgress')) || 0;
        let babyName = localStorage.getItem('babyName') || "å¯¶è²";
        let rewards = JSON.parse(localStorage.getItem('allRewards')) || ["çå‹µ1", "çå‹µ2", "çå‹µ3", "çå‹µ4", "çå‹µ5", "çµ‚æ¥µå¤§ç"];
        let rowIcons = JSON.parse(localStorage.getItem('rowIcons')) || [];
        let isAnimating = false;

        function getMsg(type) {
            const list = scripts[type];
            return list[Math.floor(Math.random() * list.length)].replace("{name}", babyName);
        }

        function initGrid() {
            grid.innerHTML = '';
            for (let i = 0; i < totalSlots; i++) {
                const slot = document.createElement('div');
                const rowIdx = Math.floor(i / 5);
                let status = (i < currentProgress) ? 'completed' : (i > currentProgress ? 'locked' : '');
                slot.className = `slot ${status}`;
                slot.innerHTML = (i < currentProgress) ? (rowIcons[rowIdx] || "â­") : "";
                slot.onclick = () => handleTap(i);
                grid.appendChild(slot);
            }
        }

        function handleTap(index) {
            if (isAnimating || index !== currentProgress) return;
            const rowIdx = Math.floor(currentProgress / 5);
            
            // æ¯ä¸€æ’çš„ç¬¬ä¸€å€‹é»æ“Šæ™‚æŠ½åœ–æ¡ˆä¸¦å„²å­˜
            if (currentProgress % 5 === 0) {
                rowIcons[rowIdx] = iconPool[Math.floor(Math.random() * iconPool.length)];
                localStorage.setItem('rowIcons', JSON.stringify(rowIcons));
            }
            
            currentProgress++;
            // å„²å­˜é€²åº¦åˆ°æœ¬åœ°ç«¯
            localStorage.setItem('bearProgress', currentProgress);
            
            initGrid();
            
            if (currentProgress % 5 === 0) {
                isAnimating = true;
                triggerGiftAnimation(rewards[rowIdx], currentProgress === 30);
            } else {
                message.innerText = (currentProgress % 5 === 4) ? getMsg('almost') : getMsg('cheers');
            }
        }

        function triggerGiftAnimation(rewardText, isFinal) {
            message.innerText = isFinal ? `ğŸŠ ${babyName}å®Œæˆäº†å¤§æŒ‘æˆ°ï¼` : `âœ¨ å®å’šï¼${babyName}å¯ä»¥é ˜çå›‰ï¼`;
            gift.classList.add('shake');
            setTimeout(() => {
                gift.classList.remove('shake');
                document.getElementById('reward-text').innerText = rewardText;
                document.getElementById('reward-title').innerText = isFinal ? "ğŸ† çµ‚æ¥µå¤§çå‹µ" : `ğŸ æ£’æ£’çå‹µ`;
                document.getElementById('reward-display').style.display = 'block';
            }, 1200);
        }

        function closeReward() {
            document.getElementById('reward-display').style.display = 'none';
            isAnimating = false;
            message.innerText = `ç¹¼çºŒåŠ æ²¹ï¼Œ${babyName}ï¼`;
        }

        function openSettings() {
            if(isAnimating) return;
            document.getElementById('baby-name-input').value = babyName;
            const container = document.getElementById('inputs-container');
            container.innerHTML = '';
            rewards.forEach((r, i) => {
                container.innerHTML += `<div style="margin-bottom:8px;"><label style="font-size:12px;">ç¬¬${(i+1)*5}æ ¼çå‹µ:</label><input type="text" class="reward-input" value="${r}" style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc;"></div>`;
            });
            document.getElementById('settings-modal').style.display = 'flex';
        }
        
        function saveSettings() {
            const newName = document.getElementById('baby-name-input').value.trim();
            if(newName) { 
                babyName = newName; 
                localStorage.setItem('babyName', babyName); 
            }
            const inputs = document.querySelectorAll('.reward-input');
            rewards = Array.from(inputs).map(input => input.value || "çå‹µ");
            // å„²å­˜çå‹µæ¸…å–®åˆ°æœ¬åœ°ç«¯
            localStorage.setItem('allRewards', JSON.stringify(rewards));
            
            document.getElementById('settings-modal').style.display = 'none';
            message.innerText = getMsg('welcome');
        }

        function clearProgress() {
            if (isAnimating) return;
            if (confirm(`ç¢ºå®šè¦å¹« ${babyName} é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿ`)) {
                localStorage.clear(); // æ¸…ç©ºæ‰€æœ‰å„²å­˜è³‡æ–™
                location.reload();    // é‡æ–°è¼‰å…¥é é¢
            }
        }

        // å•Ÿå‹•
        initGrid();
        message.innerText = getMsg('welcome');
    </script>
</body>
</html>